
package com.example.quiz.service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.quiz.dto.AdminAttemptDTO;
import com.example.quiz.dto.QuizDTO;
import com.example.quiz.dto.RankingDTO;
import com.example.quiz.dto.StudentResultDTO;
import com.example.quiz.dto.SubmitQuizRequest;
import com.example.quiz.entity.Question;
import com.example.quiz.entity.Quiz;
import com.example.quiz.entity.QuizAttempt;
import com.example.quiz.entity.User;
import com.example.quiz.repository.QuizAttemptRepository;
import com.example.quiz.repository.QuizRepository;
import com.example.quiz.repository.UserRepository;

@Service
public class QuizService {

    private final QuizRepository quizRepo;
    private final QuizAttemptRepository attemptRepo;
    private final UserRepository userRepo;

    public QuizService(QuizRepository quizRepo, QuizAttemptRepository attemptRepo, UserRepository userRepo) {
        this.quizRepo = quizRepo;
        this.attemptRepo = attemptRepo;
        this.userRepo = userRepo;
    }

    public List<QuizDTO> getQuizzesForStudent(Long userId) {
        User user = userRepo.findById(userId).orElseThrow();
        List<Quiz> quizzes = quizRepo.findAll();
        List<QuizDTO> result = new ArrayList<>();
        for (Quiz q : quizzes) {
            QuizDTO dto = new QuizDTO();
            dto.setId(q.getId());
            dto.setTitle(q.getTitle());
            dto.setDescription(q.getDescription());
            dto.setDurationMinutes(q.getDurationMinutes());
            boolean attempted = attemptRepo.findByUserAndQuiz(user, q).isPresent();
            dto.setAlreadyAttempted(attempted);
            result.add(dto);
        }
        return result;
    }

    public QuizDTO getQuizForAttempt(Long quizId) {
        Quiz quiz = quizRepo.findById(quizId).orElseThrow();
        QuizDTO dto = new QuizDTO();
        dto.setId(quiz.getId());
        dto.setTitle(quiz.getTitle());
        dto.setDescription(quiz.getDescription());
        dto.setDurationMinutes(quiz.getDurationMinutes());

        List<QuizDTO.QuestionDTO> questionDTOs = new ArrayList<>();
        for (Question q : quiz.getQuestions()) {
            QuizDTO.QuestionDTO qdto = new QuizDTO.QuestionDTO();
            qdto.setId(q.getId());
            qdto.setText(q.getText());
            qdto.setOptions(Arrays.asList(
                    q.getOptionA(),
                    q.getOptionB(),
                    q.getOptionC(),
                    q.getOptionD()
            ));
            questionDTOs.add(qdto);
        }
        dto.setQuestions(questionDTOs);
        return dto;
    }

    public int submitQuiz(Long userId, Long quizId, List<SubmitQuizRequest.AnswerInput> answers) {
        User user = userRepo.findById(userId).orElseThrow();
        Quiz quiz = quizRepo.findById(quizId).orElseThrow();

        // enforce one attempt
        if (attemptRepo.findByUserAndQuiz(user, quiz).isPresent()) {
            throw new RuntimeException("Quiz already attempted");
        }

        int score = 0;
        Map<Long, Integer> answerMap = new HashMap<>();
        for (SubmitQuizRequest.AnswerInput a : answers) {
            if (a.getQuestionId() != null && a.getSelectedOption() != null) {
                answerMap.put(a.getQuestionId(), a.getSelectedOption());
            }
        }

        for (Question q : quiz.getQuestions()) {
            Integer sel = answerMap.get(q.getId());
            if (sel != null && sel == q.getCorrectOptionIndex()) {
                score++;
            }
        }

        QuizAttempt attempt = new QuizAttempt();
        attempt.setUser(user);
        attempt.setQuiz(quiz);
        attempt.setScore(score);
        attempt.setStartedAt(LocalDateTime.now());
        attempt.setCompletedAt(LocalDateTime.now());
        attemptRepo.save(attempt);

        return score;
    }

    public List<StudentResultDTO> getResultsForStudent(Long userId) {
        User user = userRepo.findById(userId).orElseThrow();
        List<QuizAttempt> attempts = attemptRepo.findByUser(user);
        List<StudentResultDTO> result = new ArrayList<>();
        for (QuizAttempt a : attempts) {
            result.add(new StudentResultDTO(
                    a.getId(),
                    a.getQuiz().getTitle(),
                    a.getScore(),
                    a.getCompletedAt()
            ));
        }
        return result;
    }

    public List<RankingDTO> getRanking() {
        List<QuizAttempt> all = attemptRepo.findAll();

        Map<Long, Double> sumObt = new HashMap<>();
        Map<Long, Double> sumMax = new HashMap<>();
        Map<Long, String> names = new HashMap<>();

        for (QuizAttempt a : all) {
            if (a == null || a.getUser() == null || a.getQuiz() == null) continue;

            Long uid = a.getUser().getId();
            String name = a.getUser().getName();

            double obtained = a.getScore();

            int questionCount = 0;
            if (a.getQuiz().getQuestions() != null) {
                questionCount = a.getQuiz().getQuestions().size();
            }
            double max = (double) questionCount;

            sumObt.merge(uid, obtained, Double::sum);
            sumMax.merge(uid, max, Double::sum);
            names.putIfAbsent(uid, name);
        }

 
        List<RankingDTO> list = new ArrayList<>();
        for (Long uid : sumObt.keySet()) {
            double totObt = sumObt.get(uid);
            double totMax = sumMax.getOrDefault(uid, 0.0);
            double percent = (totMax > 0.0) ? (totObt / totMax) * 100.0 : 0.0;
            percent = Math.round(percent * 100.0) / 100.0; 
            list.add(new RankingDTO(uid, names.get(uid), percent));
        }

        list.sort((a, b) -> {
            int c = Double.compare(b.getTotalScore(), a.getTotalScore()); 
            if (c != 0) return c;
   
            return a.getName().compareToIgnoreCase(b.getName());
        });

     
        int rank = 0;
        Double prevPercent = null;
        for (int i = 0; i < list.size(); i++) {
            RankingDTO r = list.get(i);
            double p = r.getTotalScore();
            if (i == 0) {
                rank = 1;
            } else {
       
                if (Double.compare(p, prevPercent) != 0) {
                    rank++;
                }
            }
            r.setRank(rank);
            prevPercent = p;
        }

        return list;
    }
    
    @Transactional
    public void deleteQuiz(Long quizId) {

        // 1️⃣ First delete all attempts belonging to the quiz
        attemptRepo.deleteByQuizId(quizId);

        // 2️⃣ Now safely delete quiz
        Quiz quiz = quizRepo.findById(quizId)
                .orElseThrow(() -> new RuntimeException("Quiz not found"));
        
        quizRepo.delete(quiz);
    }

    public List<AdminAttemptDTO> getAllAttemptsForAdmin() {
        List<QuizAttempt> all = attemptRepo.findAll();
        List<AdminAttemptDTO> result = new ArrayList<>();
        for (QuizAttempt a : all) {
            result.add(new AdminAttemptDTO(
                    a.getId(),
                    a.getUser().getName(),
                    a.getQuiz().getTitle(),
                    a.getScore(),
                    a.getCompletedAt()
            ));
        }
        return result;
    }
}
